---
title: "vivid"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vivid}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo = FALSE, warning=FALSE, message=FALSE}
library(vivid)
```

## Introduction
Variable importance, interaction measures and partial dependence plots are important summaries in the interpretation of statistical and machine learning models. In this vignette we describe new visualization techniques for exploring these model summaries. We construct heatmap and graph-based displays showing variable importance and interaction jointly, which are carefully designed to highlight important aspects of the fit. We describe a new matrix-type layout showing all single and bivariate partial dependence plots, and an alternative layout based on graph Eulerians focusing on key subsets. Our new visualisations are model-agnostic and are applicable to regression and classification supervised learning settings. They enhance interpretation even in situations where the number of variables is large and the interaction structure complex. Our R package `vivid` (variable importance and variable interaction displays) provides an implementation.
\
\

## Install instructions
Some of the plots used by `vividPackage` are built upon the `zenplots` package which requires the `graph` package from BioConductor. To install the `graph` and `zenplots` packages use:

`if (!requireNamespace("graph", quietly = TRUE)){` \
  `install.packages("BiocManager")` \
  `BiocManager::install("graph")`   \
`}` \
`install.packages("zenplots")`
\
\
Now we can install `vividPackage` by using:

`install.packages("vividPackage")`
\
\
Alternatively you can install the latest development version of the package in R with the commands:

`if(!require(remotes)) install.packages('remotes')` \
`remotes::install_github('AlanInglis/vividPackage')`
\
\

We then load the required packages. `vividPackage` to create the visualizations and some other packages to create various model fits. 

```{r, warning=FALSE, message=FALSE}
library(vivid) # for visualisations 
library(randomForest) # for model fit
library(mlr3)         # for model fit
library(mlr3learners) # for model fit
library(ggplot2)
```
\
\

## Data used in this vignette:

The data used in the following examples is simulated from the Friedman benchmark problem 1^[Friedman, Jerome H. (1991) Multivariate adaptive regression splines. The Annals of Statistics 19 (1), pages 1-67.] using the `genFriedman()` function. This benchmark problem is commonly used for testing purposes. The output is created according to the equation:


<center>
$$y = 10 sin(Ï€ x1 x2) + 20 (x3 - 0.5)^2 + 10 x4 + 5 x5 + e$$
</center>

For the following examples we set the number of features to equal 10 and the number of samples is set to 450 and fit an `mlr3`-`SVM` and a `randomForest` random forest model with $y$ as the response. As the features $x_1$ to $x_5$ are the only variables in the model, therefore $x_6$ to $x_{10}$ are noise variables. As can be seen by the above equation, the only interaction is between $x_1$ and $x_2$
  

Create the data:
```{r, messages = FALSE}
set.seed(101)
myData <- genFriedman(noFeatures = 9, noSamples = 450, sigma = 1, bins = NULL, seed = NULL)
```


## Model fits 

Here we create two model fits. First we fit a SVM model from the `mlr3` package and second, we create a random forest fit from the `randomForest` package. 


* Create an `mlr3` `SVM` model:

```{r}
set.seed(101)
SVM_task  <- TaskRegr$new(id = "Friedman", backend = myData, target = "y")
set.seed(101)
SVM_lrn <- lrn("regr.svm")
set.seed(101)
SVM_mod <- SVM_lrn$train(SVM_task)
```


* Create a `randomForest` model:
```{r}
rf <- randomForest(y ~ ., data = myData, importance = TRUE)
```
Note that for a `randomForest` model, if `importance = TRUE`, then when running the `vivi` function below an importance mode must also be selected (ie., `"%IncMSE"` or `"IncNodePurity"`) via the `importanceMode` argument. 

## vivi function 

To begin, we use the `vivi` function to create a symmetrical matrix filled with pair-wise interaction strengths on the off-diagonals and variable importance on the diagonal. The matrix is ordered so that variables with high interaction strength and importance are _pushed_ to the top left.
The `vivi` uses Friedman's unnormalized H-Statistic to calculate the pair-wise interaction strength and uses either embedded feature selection methods to determine the variable importance, or if the supplied model does not support an embedded variable importance measure (e.g., the SVM fit has no embedded variable importance measure), an agnostic permutation approach will be applied automatically to generate the importance values. The unnormalized version of the H-statistic was chosen to have a more direct comparison of interaction effects across pairs of variables and the results of H are on the scale of the response.

This function works with multiple model fits and results in a matrix which can be supplied to the plotting functions. The predict function argument uses `condvis2::CVpredict` by default, which works for many fit classes.

* Create a matrix from the SVM fit to be supplied to the plotting functions.

```{r, message = F, warning = F}
set.seed(101)
SVM_fit <- vivi(fit = SVM_mod, 
                data = myData, 
                response = "y",
                gridSize = 10,
                importanceType = NULL,
                nmax = 500,
                reorder = TRUE,
                class = 1,
                predictFun = NULL)
```

 

* Create a matrix from the random forest fit to be supplied to the plotting functions.

```{r, message = F, warning = F}
set.seed(101)
rf_fit  <- vivi(fit = rf, 
                data = myData, 
                response = "y",
                gridSize = 10,
                importanceType = "%IncMSE",
                nmax = 500,
                reorder = TRUE,
                class = 1,
                predictFun = NULL)
```

## Visualizing the results

### Heatmap plot

The first visualization option supplied by `vivid` creates a heatmap plot displaying variable importance on the diagonal and variable interaction on the off-diagonal. As mentioned above, the matrix created by `vivi` is ordered. This will push variables of interest to the top left of the heatmap plot.

```{r, fig.width=6, fig.height=6, fig.align='center'}
viviHeatmap(SVM_fit) + ggtitle("SVM fit")
```
<center>
Fig 1.0: *Heatmap of a SVM fit  displaying 2-way interaction strength on the off diagonal and individual variable importance on the diagonal. $x_1$ and $x_2$ show a strong interaction with $x_4$ being the most important for predicting $y$.*
</center>


```{r, fig.width=6, fig.height=6, fig.align='center'}
viviHeatmap(rf_fit) + ggtitle("rf fit")
```
<center>
Fig 1.1: *Heatmap of a random forest fit displaying 2-way interaction strength on the off diagonal and individual variable importance on the diagonal. $x_1$ and $x_2$ show a strong interaction with $x_4$ being the most important for predicting $y$.*
</center>

### Network plot

DESCRIPTION HERE!!!

```{r, fig.width=6, fig.height=6, fig.align='center'}
viviNetwork(SVM_fit)
```
<center>
Fig 1.0: *Network plot of a SVM fit displaying 2-way interaction strength and individual variable importance. $x_1$ and $x_2$ show a strong interaction with $x_4$ being the most important for predicting $y$.*
</center>


```{r, fig.width=6, fig.height=6, fig.align='center'}
viviNetwork(rf_fit)
```
<center>
Fig 1.1: *Network plot of a random forest fit displaying 2-way interaction strength and individual variable importance. $x_1$ and $x_2$ show a strong interaction with $x_4$ being the most important for predicting $y$.*
</center>
